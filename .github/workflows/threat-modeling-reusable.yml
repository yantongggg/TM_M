name: Reusable Threat Modeling Workflow with Auto-Discovery

# Reusable workflow that can be called from other repositories
# Features:
# - Auto-discovers architecture if architecture.yaml doesn't exist
# - Performs STRIDE threat modeling using Zhipu AI
# - Returns outputs (threat counts, blocking status)
# - Comments on PRs with results

on:
  workflow_call:
    inputs:
      architecture_path:
        description: 'Path to architecture.yaml file (auto-generated if not found)'
        required: false
        type: string
        default: 'architecture.yaml'
      output_path:
        description: 'Path where threat_report.xml will be saved'
        required: false
        type: string
        default: 'threat_report.xml'
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      auto_discovery:
        description: 'Auto-generate architecture.yaml if not found (true/false)'
        required: false
        type: boolean
        default: true
      fail_on_high_severity:
        description: 'Whether to fail the workflow on Critical/High threats'
        required: false
        type: boolean
        default: true
    secrets:
      zhipu_api_key:
        description: 'Zhipu AI API key'
        required: true
    outputs:
      threat_count:
        description: 'Total number of threats found'
        value: ${{ jobs.threat-modeling.outputs.threat_count }}
      critical_count:
        description: 'Number of Critical threats'
        value: ${{ jobs.threat-modeling.outputs.critical_count }}
      high_count:
        description: 'Number of High severity threats'
        value: ${{ jobs.threat-modeling.outputs.high_count }}
      has_blocking_threats:
        description: 'Whether Critical or High threats were found'
        value: ${{ jobs.threat-modeling.outputs.has_blocking_threats }}
      architecture_generated:
        description: 'Whether architecture.yaml was auto-generated'
        value: ${{ jobs.threat-modeling.outputs.architecture_generated }}

permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  threat-modeling:
    name: Automated STRIDE Threat Modeling
    runs-on: ubuntu-latest
    outputs:
      threat_count: ${{ steps.parse_report.outputs.threat_count }}
      critical_count: ${{ steps.parse_report.outputs.critical_count }}
      high_count: ${{ steps.parse_report.outputs.high_count }}
      has_blocking_threats: ${{ steps.check_severity.outputs.has_blocking_threats }}
      architecture_generated: ${{ steps.auto_discover.outputs.generated }}

    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          path: caller-repo

      - name: Checkout threat modeling workflow repository
        uses: actions/checkout@v4
        with:
          repository: yantongggg/TMm_sCaN
          ref: master
          path: threat-modeling-repo

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r threat-modeling-repo/requirements.txt

      # === Auto-Discovery Step ===
      - name: Auto-discover architecture (if needed)
        id: auto_discover
        if: ${{ inputs.auto_discovery }}
        env:
          ZHIPU_API_KEY: ${{ secrets.zhipu_api_key }}
          ARCHITECTURE_PATH: ${{ inputs.architecture_path }}
        run: |
          cd caller-repo

          if [ -f "${{ inputs.architecture_path }}" ]; then
            echo "‚úÖ Found existing architecture.yaml"
            echo "generated=false" >> $GITHUB_OUTPUT
            echo "ARCH_FILE=${{ inputs.architecture_path }}" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è  No architecture.yaml found - running auto-discovery..."
            echo "üìÇ Analyzing codebase structure..."
            echo "ü§ñ Using AI to reverse-engineer architecture..."

            python ../threat-modeling-repo/scripts/auto_generate_arch.py

            if [ -f "architecture.yaml" ]; then
              echo "‚úÖ Successfully generated architecture.yaml"
              echo "generated=true" >> $GITHUB_OUTPUT
              echo "ARCH_FILE=architecture.yaml" >> $GITHUB_ENV

              # Show preview
              echo ""
              echo "üìÑ Generated architecture (preview):"
              echo "---"
              head -30 architecture.yaml
              echo "---"
              echo ""
            else
              echo "‚ùå Failed to generate architecture.yaml"
              exit 1
            fi
          fi

      - name: Verify architecture file exists
        if: ${{ !inputs.auto_discovery || steps.auto_discover.outputs.generated == 'false' }}
        run: |
          if [ ! -f "caller-repo/${{ inputs.architecture_path }}" ]; then
            echo "‚ùå Error: Architecture file not found at caller-repo/${{ inputs.architecture_path }}"
            echo ""
            echo "üí° Solutions:"
            echo "   1. Enable auto_discovery: true in workflow inputs"
            echo "   2. Create an architecture.yaml file in your repository"
            echo "   3. Copy the template from: threat-modeling-repo/examples/architecture-example.yaml"
            echo ""
            exit 1
          fi
          echo "‚úì Architecture file found: ${{ inputs.architecture_path }}"

      - name: Set architecture path
        id: set_arch_path
        run: |
          if [ "${{ steps.auto_discover.outputs.generated }}" = "true" ]; then
            echo "path=caller-repo/architecture.yaml" >> $GITHUB_OUTPUT
          elif [ -f "caller-repo/${{ inputs.architecture_path }}" ]; then
            echo "path=caller-repo/${{ inputs.architecture_path }}" >> $GITHUB_OUTPUT
          else
            echo "path=${{ inputs.architecture_path }}" >> $GITHUB_OUTPUT
          fi

      - name: Verify architecture file before threat modeling
        run: |
          echo "üîç Verifying architecture file..."
          arch_path="${{ steps.set_arch_path.outputs.path }}"
          if [ ! -f "$arch_path" ]; then
            echo "‚ùå Error: Architecture file not found at $arch_path"
            echo "Looking for files in caller-repo:"
            find caller-repo -name "*.yaml" -o -name "*.yml" || true
            exit 1
          fi
          echo "‚úì Architecture file exists: $arch_path"
          echo "Preview (first 20 lines):"
          head -20 "$arch_path"

      - name: Run automated threat modeling
        id: threat_model
        env:
          ZHIPU_API_KEY: ${{ secrets.zhipu_api_key }}
          ARCHITECTURE_FILE: ${{ github.workspace }}/${{ steps.set_arch_path.outputs.path }}
          OUTPUT_FILE: ${{ github.workspace }}/${{ inputs.output_path }}
        run: |
          echo "üîç Running STRIDE threat modeling..."
          echo "   Architecture: $ARCHITECTURE_FILE"
          echo "   Output: $OUTPUT_FILE"

          if [ ! -f "$ARCHITECTURE_FILE" ]; then
            echo "‚ùå Error: Architecture file not found: $ARCHITECTURE_FILE"
            exit 1
          fi

          python threat-modeling-repo/scripts/auto_threat_model.py
        continue-on-error: false

      - name: Parse threat report for outputs
        id: parse_report
        if: always()
        run: |
          if [ -f "${{ inputs.output_path }}" ]; then
            threat_count=$(grep -oP '(?<=<TotalThreats>)[^<]+' "${{ inputs.output_path }}" || echo "0")
            critical_count=$(grep -oP '(?<=<CriticalCount>)[^<]+' "${{ inputs.output_path }}" || echo "0")
            high_count=$(grep -oP '(?<=<HighCount>)[^<]+' "${{ inputs.output_path }}" || echo "0")

            echo "threat_count=$threat_count" >> $GITHUB_OUTPUT
            echo "critical_count=$critical_count" >> $GITHUB_OUTPUT
            echo "high_count=$high_count" >> $GITHUB_OUTPUT

            echo "üìä Threat Report Summary:"
            echo "  Total Threats: $threat_count"
            echo "  Critical: $critical_count"
            echo "  High: $high_count"
          else
            echo "threat_count=0" >> $GITHUB_OUTPUT
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "high_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Check severity and set status
        id: check_severity
        if: always()
        run: |
          critical_count="${{ steps.parse_report.outputs.critical_count }}"
          high_count="${{ steps.parse_report.outputs.high_count }}"

          if [ "$critical_count" -gt 0 ] || [ "$high_count" -gt 0 ]; then
            echo "has_blocking_threats=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Critical or High severity threats detected!"
          else
            echo "has_blocking_threats=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No Critical or High severity threats detected!"
          fi

      - name: Upload threat report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: threat-report-${{ github.run_number }}
          path: ${{ inputs.output_path }}
          retention-days: 90

      - name: Upload generated architecture (if auto-discovered)
        uses: actions/upload-artifact@v4
        if: ${{ steps.auto_discover.outputs.generated == 'true' }}
        with:
          name: auto-generated-architecture-${{ github.run_number }}
          path: caller-repo/architecture.yaml
          retention-days: 90

      - name: Fail build if blocking threats found
        if: ${{ inputs.fail_on_high_severity && steps.check_severity.outputs.has_blocking_threats == 'true' }}
        run: |
          echo "‚ùå BUILD FAILED: Critical or High severity threats detected!"
          echo "Critical: ${{ steps.parse_report.outputs.critical_count }}"
          echo "High: ${{ steps.parse_report.outputs.high_count }}"
          echo "Please review the threat report artifact for details."
          exit 1

      - name: Comment on PR (if triggered by PR)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '';
            const hasBlocking = '${{ steps.check_severity.outputs.has_blocking_threats }}' === 'true';
            const threatCount = '${{ steps.parse_report.outputs.threat_count }}';
            const criticalCount = '${{ steps.parse_report.outputs.critical_count }}';
            const highCount = '${{ steps.parse_report.outputs.high_count }}';
            const autoGenerated = '${{ steps.auto_discover.outputs.generated }}' === 'true';

            body += '## üîí Threat Modeling Results\n\n';

            if (autoGenerated) {
              body += '### ü§ñ Auto-Discovery\n\n';
              body += '‚ö° `architecture.yaml` was automatically generated from your codebase.\n\n';
              body += '**Recommendation:** Download the `auto-generated-architecture-${{ github.run_number }}` artifact, review it, and commit it to your repository for future runs.\n\n';
            }

            if (hasBlocking) {
              body += '### ‚ö†Ô∏è Action Required\n\n';
              body += 'Critical or High severity threats were detected that must be addressed before merging.\n\n';
              body += '| Severity | Count |\n';
              body += '|----------|-------|\n';
              body += `| üî¥ Critical | ${criticalCount} |\n`;
              body += `| üü† High | ${highCount} |\n`;
              body += `| üìä Total | ${threatCount} |\n\n`;
              body += '**Next Steps:**\n';
              body += '1. Download the `threat-report-${{ github.run_number }}` artifact\n';
              body += '2. Review the identified threats\n';
              body += '3. Implement recommended mitigations\n';
              body += '4. Re-run this workflow after making changes\n';
            } else {
              body += '### ‚úÖ No Blocking Threats\n\n';
              body += `Total threats identified: ${threatCount}\n\n`;
              body += 'The automated STRIDE threat modeling completed successfully.\n\n';
              body += 'üìÑ The detailed threat report is available in the workflow artifacts.\n';
            }

            body += '\n---\n';
            body += '*Powered by [TMm_sCaN](https://github.com/yantongggg/TMm_sCaN) - Threat Modeling as Code*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Job summary
        if: always()
        run: |
          echo "## üîí Threat Modeling Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Architecture Source** | ${{ steps.auto_discover.outputs.generated == 'true' && 'ü§ñ Auto-Generated' || 'üìÑ Repository File' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ steps.threat_model.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Architecture File** | \`${{ inputs.architecture_path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Threats** | ${{ steps.parse_report.outputs.threat_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Critical** | ${{ steps.parse_report.outputs.critical_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **High** | ${{ steps.parse_report.outputs.high_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Threat Report**: `threat-report-${{ github.run_number }}`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.auto_discover.outputs.generated }}" = "true" ]; then
            echo "- **Generated Architecture**: `auto-generated-architecture-${{ github.run_number }}`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üí° **Tip**: Review and commit the generated architecture.yaml for future runs!" >> $GITHUB_STEP_SUMMARY
          fi
