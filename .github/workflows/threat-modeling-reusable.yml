name: Reusable Threat Modeling Workflow

# Reusable workflow that can be called from other repositories
# Usage: See .github/workflows/call-threat-modeling-example.yml

on:
  workflow_call:
    inputs:
      architecture_path:
        description: 'Path to architecture.yaml file in the caller repository'
        required: false
        type: string
        default: 'architecture.yaml'
      output_path:
        description: 'Path where threat_report.xml will be saved'
        required: false
        type: string
        default: 'threat_report.xml'
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      fail_on_high_severity:
        description: 'Whether to fail the workflow on Critical/High threats'
        required: false
        type: boolean
        default: true
    secrets:
      zhipu_api_key:
        description: 'Zhipu AI API key'
        required: true
    outputs:
      threat_count:
        description: 'Total number of threats found'
        value: ${{ jobs.threat-modeling.outputs.threat_count }}
      critical_count:
        description: 'Number of Critical threats'
        value: ${{ jobs.threat-modeling.outputs.critical_count }}
      high_count:
        description: 'Number of High severity threats'
        value: ${{ jobs.threat-modeling.outputs.high_count }}
      has_blocking_threats:
        description: 'Whether Critical or High threats were found'
        value: ${{ jobs.threat-modeling.outputs.has_blocking_threats }}

permissions:
  contents: read
  pull-requests: write
  actions: write  # For uploading artifacts

jobs:
  threat-modeling:
    name: Automated STRIDE Threat Modeling
    runs-on: ubuntu-latest
    outputs:
      threat_count: ${{ steps.parse_report.outputs.threat_count }}
      critical_count: ${{ steps.parse_report.outputs.critical_count }}
      high_count: ${{ steps.parse_report.outputs.high_count }}
      has_blocking_threats: ${{ steps.check_severity.outputs.has_blocking_threats }}

    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          path: caller-repo

      - name: Checkout threat modeling workflow repository
        uses: actions/checkout@v4
        with:
          repository: yantongggg/TMm_sCaN
          ref: master
          path: threat-modeling-repo

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r threat-modeling-repo/requirements.txt

      - name: Verify architecture file exists
        run: |
          if [ ! -f "caller-repo/${{ inputs.architecture_path }}" ]; then
            echo "‚ùå Error: Architecture file not found at caller-repo/${{ inputs.architecture_path }}"
            echo "Please create an architecture.yaml file in your repository."
            echo "You can copy the example from: threat-modeling-repo/architecture.yaml"
            exit 1
          fi
          echo "‚úì Architecture file found: ${{ inputs.architecture_path }}"

      - name: Run automated threat modeling
        id: threat_model
        env:
          ZHIPU_API_KEY: ${{ secrets.zhipu_api_key }}
          ARCHITECTURE_FILE: ${{ github.workspace }}/caller-repo/${{ inputs.architecture_path }}
          OUTPUT_FILE: ${{ github.workspace }}/${{ inputs.output_path }}
        run: |
          python threat-modeling-repo/scripts/auto_threat_model.py
        continue-on-error: true

      - name: Parse threat report for outputs
        id: parse_report
        if: always()
        run: |
          if [ -f "${{ inputs.output_path }}" ]; then
            threat_count=$(grep -oP '(?<=<TotalThreats>)[^<]+' "${{ inputs.output_path }}" || echo "0")
            critical_count=$(grep -oP '(?<=<CriticalCount>)[^<]+' "${{ inputs.output_path }}" || echo "0")
            high_count=$(grep -oP '(?<=<HighCount>)[^<]+' "${{ inputs.output_path }}" || echo "0")

            echo "threat_count=$threat_count" >> $GITHUB_OUTPUT
            echo "critical_count=$critical_count" >> $GITHUB_OUTPUT
            echo "high_count=$high_count" >> $GITHUB_OUTPUT

            echo "üìä Threat Report Summary:"
            echo "  Total Threats: $threat_count"
            echo "  Critical: $critical_count"
            echo "  High: $high_count"
          else
            echo "threat_count=0" >> $GITHUB_OUTPUT
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "high_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Check severity and set status
        id: check_severity
        if: always()
        run: |
          critical_count="${{ steps.parse_report.outputs.critical_count }}"
          high_count="${{ steps.parse_report.outputs.high_count }}"

          if [ "$critical_count" -gt 0 ] || [ "$high_count" -gt 0 ]; then
            echo "has_blocking_threats=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Critical or High severity threats detected!"
          else
            echo "has_blocking_threats=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No Critical or High severity threats detected!"
          fi

      - name: Upload threat report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: threat-report-${{ github.run_number }}
          path: ${{ inputs.output_path }}
          retention-days: 90

      - name: Fail build if blocking threats found
        if: ${{ inputs.fail_on_high_severity && steps.check_severity.outputs.has_blocking_threats == 'true' }}
        run: |
          echo "‚ùå BUILD FAILED: Critical or High severity threats detected!"
          echo "Critical: ${{ steps.parse_report.outputs.critical_count }}"
          echo "High: ${{ steps.parse_report.outputs.high_count }}"
          echo "Please review the threat report artifact for details."
          exit 1

      - name: Comment on PR (if triggered by PR)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '';
            const hasBlocking = '${{ steps.check_severity.outputs.has_blocking_threats }}' === 'true';
            const threatCount = '${{ steps.parse_report.outputs.threat_count }}';
            const criticalCount = '${{ steps.parse_report.outputs.critical_count }}';
            const highCount = '${{ steps.parse_report.outputs.high_count }}';

            body += '## üîí Threat Modeling Results\n\n';
            body += `**Architecture File**: \`${{ inputs.architecture_path }}\`\n\n`;

            if (hasBlocking) {
              body += '### ‚ö†Ô∏è Action Required\n\n';
              body += 'Critical or High severity threats were detected that must be addressed before merging.\n\n';
              body += '| Severity | Count |\n';
              body += '|----------|-------|\n';
              body += `| üî¥ Critical | ${criticalCount} |\n`;
              body += `| üü† High | ${highCount} |\n`;
              body += `| üìä Total | ${threatCount} |\n\n`;
              body += '**Next Steps:**\n';
              body += '1. Download the `threat-report-${{ github.run_number }}` artifact\n';
              body += '2. Review the identified threats\n';
              body += '3. Implement recommended mitigations\n';
              body += '4. Re-run this workflow after making changes\n';
            } else {
              body += '### ‚úÖ No Blocking Threats\n\n';
              body += `Total threats identified: ${threatCount}\n\n`;
              body += 'The automated STRIDE threat modeling completed successfully.\n\n';
              body += 'üìÑ The detailed threat report is available in the workflow artifacts.\n';
            }

            body += '\n---\n';
            body += '*Powered by [TMm_sCaN](https://github.com/yantongggg/TMm_sCaN) - Threat Modeling as Code*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Job summary
        if: always()
        run: |
          echo "## üîí Threat Modeling Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ steps.threat_model.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Architecture File** | \`${{ inputs.architecture_path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Threats** | ${{ steps.parse_report.outputs.threat_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Critical** | ${{ steps.parse_report.outputs.critical_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **High** | ${{ steps.parse_report.outputs.high_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Download the Threat Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the detailed XML report from the workflow artifacts." >> $GITHUB_STEP_SUMMARY
